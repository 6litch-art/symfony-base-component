{% use "@Twig/Form/form_div_layout.html.twig" %}

{# Overriding the EA form overriding >( #}
{% block form_start %}
    {{ parent() }}
        <input type="hidden" name="referrer" value="{{ ea.request.query.get('referrer') }}">
        {% if form.vars.errors|length > 0 and 'ea_crud' in form.vars.block_prefixes|default([]) %}
            {{ form_errors(form, {attr: { class: 'global-invalid-feedback' }}) }}
        {% endif %}

{% endblock form_start %}

{% block form_end %}
        {% if not render_rest is defined or render_rest %}
            {{ form_rest(form) }}
        {% endif %}
    </form>
{% endblock %}

{# Overloaded form template.. #}
{%- block form2_label  -%}{{- form_label(form)  -}}{%- endblock -%}
{%- block form2_widget -%}{{- form_widget(form) -}}{%- endblock -%}
{%- block form2_errors -%}
{%- set row_attr = row_attr|merge({'class': 'form-errors' ~ (row_attr.class is defined ? ' ' ~ row_attr.class : '')} ) -%}
{% if errors|length %}
    <div {% with {attr: row_attr} %}{{ block('attributes') }}{% endwith %}>{{- form_errors(form) -}}</div>
{% endif %}
{%- endblock -%}

{%- block form2_help   -%}
    {% if help is not empty %}
    <span class="data-help">
        <i class="far fa-question-circle" data-bs-toggle="tooltip" data-bs-placement="right" title="{{help}}"></i>
    </span>
    {% endif %}
{%- endblock -%}

{% block form2_row -%}
    {# {%- set attr = attr|merge({'class': 'form-control' ~ (attr.class is defined ? ' ' ~ attr.class : '')} ) -%} #}
    {# {%- set row_attr = row_attr|merge({'class': 'form-group' ~ (row_attr.class is defined ? ' ' ~ row_attr.class : '')} ) -%} #}
    <div {% with {attr: row_attr} %}{{ block('attributes') }}{% endwith %}>
        <span>{{- form_label(form) -}}{{- form_help(form) -}}</span>

        {% set _form_error = form_errors(form, {row_attr:{}}) %}
        {% if _form_error is not empty %}
            {%- set attr = attr|merge({'class': 'is-invalid' ~ (attr.class is defined ? ' ' ~ attr.class : '')} ) -%}
        {% endif %}

        {{- form_widget(form, {attr:attr}) -}}
        {{- _form_error|raw -}}
    </div>
{%- endblock form2_row -%}

{# Custom FormType widgets are below.. #}
{%- block quill_row -%}
<div class="form-quill form-group">
    <span>{{ form_label(form) }}</span>
    {{ form_errors(form) }}
    {{ form_row(form) }}
</div>
{%- endblock -%}
{%- block quill_widget -%}

    {% set attr = attr|merge({
        'data-quill-field': form.vars.id,
       'data-quill-options': quill
    }) %}

    {{ form_widget(form) }}
    <div id="{{ id }}_editor" {{ block('attributes') }}>
        {{ value | raw }}
    </div>

{%- endblock quill_widget -%}

{%- block select2_row -%}
    {%- set attr = attr|merge({'class': 'form-select2' ~ (attr.class is defined ? ' ' ~ attr.class : '')} ) -%}
    {{form_row(form)}}    
{%- endblock -%}

{%- block attribute_widget -%}
<div class="form-control form-attribute">
    {{ form_widget(form.choice) }}
    {% if form.intl is defined %} {{ form_widget(form.intl) }} {% endif %}
</div>
{% endblock attribute_widget %}

{%- block select2_widget -%}

    {% set attr = attr|merge({
        'data-select2-field'   : form.vars.id~"_choice",
        'data-select2-options' : select2,
        'data-select2-sortable': form.vars["select2-sortable"],
    }) %}

    {{ form_widget(form.choice, {attr: attr, row_attr:row_attr}) }}

{% endblock select2_widget %}

{%- block discriminator_row -%}
    {%- set attr = attr|merge({'class': 'form-select2' ~ (attr.class is defined ? ' ' ~ attr.class : '')} ) -%}
    {{form_row(form)}}    
{%- endblock -%}

{%- block discriminator_widget -%}
    {{ form_widget(form.choice, {attr: attr, row_attr:row_attr}) }}
{% endblock discriminator_widget %}

{%- block datetimepicker_widget -%}
    {% set attr = attr|merge({
        'data-datetimepicker-field': form.vars.id,
        'data-datetimepicker-options': datetimepicker
    }) %}

    <div class="input-group form-stock">
        <div class="input-group-text">
            <button class="btn btn-outline-secondary" type="button" id="{{form.vars.id}}-btn">
                <i class="fas fa-calendar-day"></i>
            </button>
        </div>
        {{ form_widget(form, {attr:attr}) }}
    </div>
{% endblock datetimepicker_widget %}

{%- block translatable_row -%}
    {{ form_widget(form) }}
{%- endblock -%}

{%- block translatable_widget -%}
    {% set row_attr = row_attr|merge({'class': 'form-translatable' ~ (row_attr.class is defined ? ' ' ~ row_attr.class : '')} ) %}
    <div {% with {attr: row_attr} %}{{ block('attributes') }}{% endwith %}>
        
    {% if form.children|length == 1 and single_locale %}

        {% for row in form.children %}
        
            {% if form.vars.row_inline == false %}
                {{ form_widget(row) }}
            {% else %}
                {{ form_row(row) }}
            {% endif %}
        {% endfor %}

    {% else %}

        {% if translations_empty is defined and translations_empty == false %}

                <ul class="nav nav-tabs" role="tablist" id="{{ form.vars['id'] }}_nav">

                {% for form_locale, form_child in form.children %}
                    {% if form_locale in form.vars.available_locales %}
                    <li class="nav-item" role="presentation">

                        {% set lang    = form_locale|lang %}
                        {% set country = form_locale|country %}

                        <button class="nav-link {% if locale == form_locale %}active{% endif %}" id="{{ form.vars['id']~"_"~country}}-tab" data-bs-toggle="tab" data-bs-target="#{{ form.vars['id']~"_"~country}}" type="button" role="tab" aria-controls="{{country}}" aria-selected="true">
                            <label {% if form_child.vars['required'] %}class="required"{% endif %}>
                                <img class="country-flag {% if default_locale == form_locale %}default{% endif %} " src="{{asset('bundles/base/flags/'~ country~'.png')}}" alt="{{ form_locale }}">
                            </label>
                        </button>
                    </li>
                    {% endif %}
                {% endfor %}
                </ul>

                <div class="tab-content" id="{{ form.vars['id'] }}_tab">
                {% for form_locale, formChild in form.children %}
                    {% if form_locale in form.vars.available_locales %}
                        {% set lang    = form_locale|lang %}
                        {% set country = form_locale|country %}
                        <div class="tab-pane fade {% if locale == form_locale %}show active{% endif %}" id="{{ form.vars['id']~"_"~country}}" role="tabpanel" aria-labelledby="{{ form.vars['id']~"_"~country}}-tab">
                            {% for row in formChild %}
                                {{ form_row(row) }}
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endfor %}
                </div>
        {% endif %}

    {% endif %}
    </div>
{%- endblock translatable_widget -%}

{%- block pattern_widget -%}
    {% set attr = attr|merge({
        'data-pattern-field': form.vars.id,
        'data-pattern': pattern
    }) %}

    <div class="input-group mb-3">
    <div class="input-group-text" id="basic-addon3">https://example.com/users/</div>
    <input type="text" class="form-control" id="basic-url" aria-describedby="basic-addon3">
    <div class="input-group-text">$</div>
    <input type="text" class="form-control" aria-label="Amount (to the nearest dollar)">
    <div class="input-group-text">.00</div>
    <input type="text" class="form-control" placeholder="Username" aria-label="Username">
    <div class="input-group-text">@</div>
    <input type="text" class="form-control" placeholder="Server" aria-label="Server">
    <div class="input-group-text">.com</div>
    </div>
    <div class="input-group">
        {{ block('form_widget') }}
        <div class="input-group-append">
            <button class="input-group-text" type="button">
                <i class="fas fa-lock fa-fw"></i>
            </button>
        </div>
    </div>
{%- endblock -%}

{%- block slug_widget -%}

{# Search for target inside form based on parent including translation #}
{% set form = form.parent %}
{% for child in target %}

    {% set form = form[child] %}

    {% if child == "translations" %}
        {% if form.vars.default_locale is defined and form.vars.default_locale in form|keys %}
            {% set form = form[form.vars.default_locale] %}
        {% else %} 
            {% set form = form|first %}
        {% endif %}
    {% endif %}
{% endfor %}

{# Define slug parameters #}
{% set attr = attr|merge({
    'data-slug-field': '',
    'data-target': form.vars.id
}) %}

<div class="input-group">
    {{ block('form_widget') }}
    <div class="input-group-append">
        <button class="input-group-text" type="button">
            <i class="fas fa-lock fa-fw"></i>
        </button>
    </div>
</div>

{%- endblock -%}

{%- block percent_widget -%}
    <div class="input-group">
        {{ block('form_widget') }}
        <div class="input-group-append">
            <button class="input-group-text" type="button">
                <i class="fas fa-percent fa-fw"></i>
            </button>
        </div>
    </div>
{%- endblock -%}

{%- block avatar_widget -%}

{% set attr = attr|merge({
    'data-avatar-field'   : form.vars.id,
    'data-avatar-cropper' : form.vars.cropper,
}) %}

<div class="avatarupload" {{ block('attributes') }}>

    {{ form_widget(form, { attr: form.vars.attr }) }}

    {% if allow_delete %}
    <div id="{{id}}_deleteBtn2" class="deleteBtn" style="{% if avatar is empty %}display:none;{% endif %}">
        <i class="fas fa-plus-circle fa-2x"></i>
    </div>
    {% endif %}
</div>
{%- endblock -%}

{%- block imageupload_widget -%}
{% set attr = attr|merge({
    'data-image-field'         : form.vars.id,
    'data-image-cropper'       : form.vars.cropper,
    'data-image-thumbnail'     : form.vars.thumbnail,
    'data-image-ajax'      : form.vars.ajax,
}) %}

<div class="imageupload" {{ block('attributes') }}>

    {% if not multiple %}
        <figure>
            <img id="{{id}}_thumbnail" style="cursor: pointer;" src="{{ form.vars.value | default(thumbnail) }}" />
            <figcaption id="{{id}}_figcaption">
                <i class="fas fa-plus-circle fa-3x"></i>
            </figcaption>
        </figure>

        {% if cropper %}

            <!-- Modal -->
            <div class="modal fade" id="{{id}}_modal">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Image cropper</h5>
                    <button type="button" class="btn-close {{id}}_modalClose" aria-label="Close">
                    </button>
                </div>
                <div class="modal-body">
                    <div class="img-container">
                        <img id="{{id}}_cropper" src="" style="visibility:hidden">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary {{id}}_modalClose">Cancel</button>
                    <button type="button" class="btn btn-primary" id="{{id}}_modalSave">Save changes</button>
                </div>
                </div>
            </div>
            </div>

        {% endif %}
    {% endif %}

    {{ form_widget(form, { attr: form.vars.attr }) }}

</div>
{%- endblock -%}

{%- block fileupload_widget -%}

{% set attr = attr|merge({
    'data-file-sortable'              : form.vars.sortable,
    'data-file-ajax'                  : form.vars.ajax,
    'data-file-max-files'             : form.vars.max_files,
    'data-file-href'                  : form.vars.href|default("")|url_decode,
    'data-file-counter[none]'         : "@fields.fileupload.file_counter.none"       | trans(["{0}"]),
    'data-file-counter[singular]'     : "@fields.fileupload.file_counter.singular"   | trans(["{0}"]),
    'data-file-counter[plural]'       : "@fields.fileupload.file_counter.plural"     | trans(["{0}"]),
    'data-file-counter-max[none]'     : "@fields.fileupload.file_counter_max.none"    | trans(["{0}"]),
    'data-file-counter-max[singular]' : "@fields.fileupload.file_counter_max.singular"| trans(["{0}"]),
    'data-file-counter-max[plural]'   : "@fields.fileupload.file_counter_max.plural"  | trans(["{0}"])
}) %}

<div class="fileupload" data-file-field="{{ id }}" data-file-dropzone="{{form.vars.dropzone}}">
    <div class="field">
    {% if multiple and dropzone %}

        <div id="{{ id }}_dropzone" {{ block('attributes') }}></div>
        {{ form_widget(form.file, { id: id, value:value }) }}

    {% else %}

        {% set placeholder = '' %}
        {% set title = '' %}
        {% set filesLabel = 'files'|trans %}

        {{ form_widget(form.file, { attr: form.file.vars.attr, value: value }) }}
        {{ form_widget(form.raw, { attr: form.raw.vars.attr|merge({ accept: accept|join(',') }) }) }}
    
        {% if allow_delete %}
        <div id="{{id}}_deleteBtn" class="deleteBtn" style="{% if files is empty %}display:none;{% endif %}">
            <span style="cursor:pointer;">&#x2715;</span>
        </div>
        {% endif %}

    {% endif %}
    </div>

    {% if form.vars.max_filesize %}
    <div class="form-filesize form-text text-muted">{{"@fields.fileupload.max_file"|trans([form.vars.max_filesize|filesize])}}</div>
    {% endif %}
    
    {% set exts = form.vars.accept|extension %}
    {% if exts is not empty %}
    <div class="form-filesize form-text text-muted">{{"@fields.fileupload.mime_type"|trans([exts|length, exts|join(', ')|upper])}}</div>
    {% endif %}

    {%- set row_attr = row_attr|merge({'class': 'form-text text-muted' ~ (row_attr.class is defined ? ' ' ~ row_attr.class : '')} ) -%}
    {{ form_errors(form.raw, {row_attr:row_attr}) }}

    {% if multiple %}
    <div id="{{id}}_metadata" class="form-text text-muted"></div>
    {% endif %}

</div>

{%- endblock -%}

{%- block associationfile_widget -%}
    {% for childForm in form.children %}
        {% set attr = childForm.vars.attr|merge({'data-entity-id': form.vars.entityId }) %}
        {{ form_widget(childForm, {attr:attr}) }}
    {% endfor %}
{% endblock associationfile_widget %}

{%- block association_label -%}
    {% if form.vars.multiple %}
        {{ form_label(form, null, {'required': false}) }}
    {% else %}
        {{ form_label(form, null, {'required': form.vars.required}) }}
    {% endif %}
{%- endblock -%}

{%- block association_row -%}
    {% if form.parent.parent is null and multiple %}
    
        {% if form.children is iterable %}
             {# e.g. OneToMany relations result in such one-size array structure.. 
                     it is not clear to me why sometimes it does and sometimes not.. #}
            {% set formChild = form.children|first %}
        {% else %}
            {% set formChild = form.children %}
        {% endif %}

        {% if formChild.vars.prototype is defined and not formChild.vars.prototype.rendered %}
            {% set prototype_row = form_row(formChild.vars.prototype, {attr:{"class": "form-control"}}) %}
            {% set attr = attr|merge({ 'data-prototype': prototype_row}) %}
        {% endif %}

        {% set attr = attr|merge({
            'data-collection-field': 'true',
            'data-allow-add': formChild.vars.allow_add ? 'true' : 'false',
            'data-allow-delete': formChild.vars.allow_delete ? 'true' : 'false',
            'data-num-items': formChild is empty ? 0 : max(formChild|keys),
            'data-form-type-name-placeholder': formChild.vars.prototype is defined ? formChild.vars.prototype.vars.name : '',
            'data-empty-collection': block('collection2_empty') 
        }) %}

        {% set attr = attr | filter((v, k) => k != 'class' and v != 'form-control')%}
        {%- set attr = attr|merge({'class': 'form-collection' ~ (attr.class is defined ? ' ' ~ attr.class : '')} ) -%}

        <div class="form-group">
            {{ form_label(form)}}
            <div {{ block('widget_attributes') }}>
                {{ form_widget(formChild) }}
            </div>
        </div>
    {% else %}
        {% set attr = attr | filter((v, k) => k != 'class' and v != 'form-control')%}
        {%- set attr = attr|merge({'class': 'form-entity' ~ (attr.class is defined ? ' ' ~ attr.class : '')} ) -%}
        {{ form_widget(form, {attr: attr}) }}
    {% endif %}
    
{%- endblock -%}

{%- block collection2_row -%}

    {% if prototype is defined and not prototype.rendered %}
        {% set prototype_row = form_row(prototype, {attr:{"class": "form-control"}}) %}
        {% set attr = attr|merge({ 'data-prototype': prototype_row}) %}
    {% endif %}

    {% set attr = attr|merge({
        'data-collection-field': 'true',
        'data-allow-add': allow_add ? 'true' : 'false',
        'data-allow-delete': allow_delete ? 'true' : 'false',
        'data-num-items': form.children is empty ? 0 : max(form.children|keys),
        'data-form-type-name-placeholder': prototype is defined ? prototype.vars.name : '',
        'data-empty-collection': block('collection2_empty')
    }) %}
    
    {% set attr = attr | filter((v, k) => k != 'class' and v != 'form-control')%}
    {%- set attr = attr|merge({'class': 'form-collection' ~ (attr.class is defined ? ' ' ~ attr.class : '')} ) -%}

    {% set inline = form.vars.entry_inline|default(false) %}
    {% if inline == true %}
        {{ form_widget(form, {attr:attr}) }}
    {% else %}
        {% if form.children is not empty or allow_add != false %}
        <div class="form-group">
            {{ form_label(form)}}
            <div {{ block('widget_attributes') }}>
                {{ form_widget(form) }}
            </div>
        </div>
        {% endif %}
    {% endif %}

{%- endblock collection2_row -%}

{%- block collection2_label -%}
    {{ form_label(form, null, {'required': false}) }}
{%- endblock -%}

{%- block collection2_widget -%}

    {# the "is iterable" check is needed because if an object implements __toString() and
               returns an empty string, "is empty" returns true even if it's not a collection #}

    {% set isEmptyCollection = value is null or (value is iterable and value is empty) %}
    {% if  isEmptyCollection %}
        {{ block('collection2_empty') }}
    {% else %}
        {% set attr = attr|merge({'class': 'form-collection-items' ~ (attr.class is defined ? ' ' ~ attr.class : '')} ) %}
        {{ form_widget(form, {attr: attr}) }}
    {% endif %}
    
    {% if allow_add|default(false) %}
        <button type="button" class="btn btn-link form-collection-add-button">
            <i class="fa fa-plus pr-1"></i>
            {{ '@EasyAdminBundle.action.add_new_item'|trans }}
        </button>
    {% endif %}
{%- endblock collection2_widget -%}

{%- block collection2_entry_row -%}
    {{ form_row(form) }}
{%- endblock collection2_entry_row -%}

{%- block collection2_entry_widget -%}

    {% set inline = form_parent(form).vars.entry_inline|default(false) %}
    {% set row_inline = form_parent(form).vars.entry_row_inline|default(false) %}
    {% if inline == true %}

        {% if row_inline == false %}
            {% if form_parent(form).vars.entry_label == true %}
                <label>{{ value|ea_as_string }}</label>
            {% endif %}
            <div class="form-collection-inline">
            {{ form_widget(form, {attr:attr}) }}
            </div>
        {% else %}
            {{ form_widget(form, {attr:attr}) }}
        {% endif %}
    {% else %}

        {% set allows_deleting_items = form_parent(form).vars.allow_delete|default(false) %}
        {% set delete_item_button %}
            <button type="button" class="btn btn-link btn-link-danger form-collection-delete-button"
                    title="{{ 'action.remove_item'|trans({}, 'EasyAdminBundle') }}">
                <i class="far fa-trash-alt"></i>
            </button>
        {% endset %}

        <div class="accordion form-collection-item">
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#{{ id }}-contents">
                        <i class="fas fw fa-chevron-right form-collection-item-collapse-marker"></i>
                        {{ form_parent(form).vars.entry_label|default(value)|ea_as_string }}
                    </button>

                    {% if allows_deleting_items %}
                        {{ delete_item_button }}
                    {% endif %}
                </h2>
                <div id="{{ id }}-contents" class="accordion-collapse collapse">
                    <div class="accordion-body">
                        {{ form_widget(form, {attr:attr}) }}
                    </div>
                </div>
            </div>
        </div>

    {% endif %}

{%- endblock collection2_entry_widget -%}

{%- block collection2_empty -%}
    <div class="empty collection-empty"></div>
{%- endblock collection2_empty -%}

{%- block stock_widget -%}
    
{% set attr = attr|merge({
    'data-stock-field': form.vars.id,
    'data-stock-unlimited': "@fields.stock.unlimited"|trans,
    "min": form.vars.min is defined and form.vars.max > 0 ? form.vars.max : 0,
}) %}

{% if form.vars.max is defined %}
    {% set attr = attr|merge({max: form.vars.max}) %}
{% endif %}

<div class="input-group form-stock">
    <div class="input-group-text">
        <button class="btn btn-outline-secondary" id="{{form.vars.id}}-btn" type="button">
            <i class="fas fa-box-open"></i>
        </button>
    </div>
    {{ form_widget(form, {attr:attr}) }} {# NumberType is returning and input type text... #}
    {# <input type="number" {% with {attr: attr} %}{{ block('attributes') }}{% endwith %} id="{{form.vars.id}}"  name="{{form.vars.id}}" value="{{form.vars.value}}"> #}
    <div class="input-group-text">
        <button class="btn btn-outline-secondary" id="{{form.vars.id}}-down" type="button"><i class="fas fa-minus"></i></button>
    </div>
     <div class="input-group-text">
        <button class="btn btn-outline-secondary" id="{{form.vars.id}}-up" type="button"><i class="fas fa-plus"></i></button>
    </div>
</div>

{%- endblock -%}

{%- block password_row -%}
    {%- set row_attr = row_attr|merge({'class': 'col-md-6 form-group' ~ (row_attr.class is defined ? ' ' ~ row_attr.class : '')} ) -%}
    {{form_row(form, {row_attr:row_attr})}}
{%- endblock -%}

{%- block money_widget -%}

{# Search for target inside form based on parent including translation #}
{% set currencyForm = form.parent %}
{% for child in currency_target %}

    {% set currencyForm = currencyForm[child] %}

    {% if child == "translations" %}
        {% if currencyForm.vars.default_locale is defined and currencyForm.vars.default_locale in currencyForm|keys %}
            {% set currencyForm = currencyForm[currencyForm.vars.default_locale] %}
        {% else %} 
            {% set currencyForm = currencyForm|first %}
        {% endif %}
    {% endif %}
{% endfor %}

{% set attr = attr|merge({
    'data-currency-field': currencyForm.vars.id,
    'data-scale-field': form.vars.scale ?? ''
}) %}

<div class="input-group form-money">

    {{ block('form_widget') }}
    <div class="input-group-append">
        {% set currency_list = form.vars.currency_list is defined ? form.vars.currency_list : [] %}
        {%  if currency_list is empty or currency_list is not iterable %}
            <button id="{{form.vars.id}}-btn" class="input-group-text" type="button">
                {{form.vars.currency_pattern|trans({"{{ widget }}":""})|trim}}
                {{form.vars.currency_label ?? ""|trim}}
            </button>
        {% else %}
            {% set code     = currency %}
            {% set label    = currency_label[code] ?? code %}
            {% set exchange = currency_exchange[code] ?? 1 %}
            <button id="{{form.vars.id}}-btn" class="input-group-text dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">{{label}}</button>
            <ul id="{{form.vars.id}}-list" class="dropdown-menu dropdown-menu-end" >

                <li id="{{form.vars.id}}-selected" data-label="{{label}}" data-code="{{code}}" data-exchange="{{ exchange }}"><a class="dropdown-item">{{label}}</a></li>
                <li><hr class="dropdown-divider"></li>

                {% for code in currency_list %}
                    {% set label    = currency_label[code] ?? code %}
                    {% set exchange = currency_exchange[code] ?? 1 %}
                    <li class="item" data-label="{{label}}" data-code="{{code}}" data-exchange="{{ exchange }}"><a class="text-right dropdown-item">{{label}}</a></li>
                {% endfor %}
            </ul>
        {% endif %}
    </div>
</div>

{%- endblock -%}